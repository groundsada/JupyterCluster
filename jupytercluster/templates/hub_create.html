{% extends "page.html" %}
{% block title %}Create Hub - JupyterCluster{% end %}
{% block main %}
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h1>Create New Hub</h1>
      </div>
    </div>

    {% if error %}
      <div class="row mt-3">
        <div class="col-12">
          <div class="alert alert-danger">{{ error }}</div>
        </div>
      </div>
    {% end %}

    <div class="row mt-4">
      <div class="col-md-8">
        <form method="post" action="{{ base_url }}hubs/create">
          <input type="hidden" name="_xsrf" value="{{ xsrf }}" />
          <div class="mb-3">
            <label for="name" class="form-label">Hub Name <span class="text-danger">*</span></label>
            <input type="text" 
                   class="form-control" 
                   id="name" 
                   name="name" 
                   required
                   pattern="[a-z0-9]([-a-z0-9]*[a-z0-9])?"
                   title="Lowercase alphanumeric characters and hyphens only">
            <small class="form-text text-muted">
              Must be a valid Kubernetes name (lowercase alphanumeric and hyphens only)
            </small>
            {% if allowed_namespace_prefixes %}
              <div class="alert alert-info mt-2 mb-0">
                <small>
                  <i class="fa fa-info-circle"></i> 
                  <strong>Namespace Restriction:</strong> This hub will be created in namespace 
                  <code>{{ default_namespace_prefix }}{{ '<hub-name>' }}</code>, 
                  which must start with one of: 
                  {% for prefix in allowed_namespace_prefixes %}
                    <code>{{ prefix }}</code>{% if not (prefix == allowed_namespace_prefixes[-1]) %}, {% end %}
                  {% end %}
                </small>
              </div>
            {% end %}
            {% if max_hubs %}
              <div class="alert alert-warning mt-2 mb-0">
                <small>
                  <i class="fa fa-exclamation-triangle"></i> 
                  <strong>Hub Limit:</strong> You have {{ current_hub_count }} / {{ max_hubs }} hubs. 
                  {% if current_hub_count >= max_hubs %}
                    <strong>You have reached your limit!</strong>
                  {% else %}
                    You can create {{ max_hubs - current_hub_count }} more hub(s).
                  {% end %}
                </small>
              </div>
            {% end %}
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" 
                      id="description" 
                      name="description" 
                      rows="3"
                      placeholder="Optional description for this hub"></textarea>
          </div>

          <div class="mb-3">
            <label for="values" class="form-label">Helm Values (YAML or JSON)</label>
            <div class="btn-group mb-2" role="group">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadMinimalConfig()">
                <i class="fa fa-magic"></i> Load Minimal Config (Kind/Dev)
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadProductionConfig()">
                <i class="fa fa-server"></i> Load Production Config (Ceph/West)
              </button>
            </div>
            <textarea class="form-control font-monospace" 
                      id="values" 
                      name="values" 
                      rows="10"
                      placeholder='hub:
  config:
    JupyterHub:
      authenticator_class: dummy'></textarea>
            <small class="form-text text-muted">
              Optional YAML or JSON configuration to override default Helm values for the JupyterHub instance.
              Use buttons above to load pre-configured templates.
            </small>
          </div>

          <div class="mb-3">
            <button type="submit" class="btn btn-primary">
              <i class="fa fa-plus"></i> Create Hub
            </button>
            <a href="{{ base_url }}home" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
{% end %}
{% block script %}
<script>
function loadMinimalConfig() {
  const minimalConfig = `hub:
  config:
    JupyterHub:
      authenticator_class: dummy
  service:
    type: ClusterIP
singleuser:
  storage:
    type: none
  image:
    name: quay.io/jupyter/scipy-notebook
    tag: latest
  cpu:
    limit: 1
    guarantee: 0.1
  memory:
    limit: 1G
    guarantee: 128M
ingress:
  enabled: false
proxy:
  service:
    type: ClusterIP`;
  
  document.getElementById('values').value = minimalConfig;
}

function loadProductionConfig() {
  const productionConfig = `hub:
  config:
    JupyterHub:
      authenticator_class: dummy
  service:
    type: ClusterIP
  db:
    type: sqlite-pvc
    pvc:
      accessModes:
      - ReadWriteOnce
      storage: 1Gi
      storageClassName: rook-ceph-block
singleuser:
  storage:
    type: dynamic
    capacity: 5Gi
    dynamic:
      storageClass: rook-ceph-block
      pvcNameTemplate: claim-{username}{servername}
      volumeNameTemplate: volume-{username}{servername}
      storageAccessModes:
      - ReadWriteOnce
    extraVolumes: []
    extraVolumeMounts: []
  image:
    name: quay.io/jupyter/scipy-notebook
    tag: '2024-04-22'
  cpu:
    limit: 3
    guarantee: 3
  memory:
    limit: 10G
    guarantee: 10G
  extraNodeAffinity:
    required:
    - matchExpressions:
      - key: topology.kubernetes.io/region
        operator: In
        values:
        - us-west
ingress:
  enabled: true
  ingressClassName: haproxy
  hosts:
  - your_name.nrp-nautilus.io
proxy:
  service:
    type: ClusterIP`;
  
  document.getElementById('values').value = productionConfig;
}
</script>
{% end %}

